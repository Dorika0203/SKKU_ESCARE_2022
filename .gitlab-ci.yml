stages:
  - build-job
  - build
  - deploy
variables:
  IMAGE_NAME: tim0726/kakaotest:0.1


build-job:
  stage: build-job
  tags:
    - ubtag
  image: openjdk:11
  script:
    - ./gradlew bootWar
  cache:
    key: whenever-with-dependencies
    paths:
      - .gradle/wrapper
      - .gradle/caches
  artifacts:
    paths:
      - ./build/libs/app.war

docker-build-push:
  tags:
    - ubtag
  image: docker:latest
  stage: build
  script:
    - echo hi
    - docker login -u $DOCKER_ID -p $DOCKER_PASSWORD
    - docker build -t tim0726/kakaotest:0.1 .
    - docker push tim0726/kakaotest:0.1



# ---------------------------------------------------------------------------------------- deployment -------------------------------------------------------------------- #

# This is deploying for DEVELOPMENT process, for testing.
# Using server is contributor dorika's personal server -- ubuntu 20.04 server.
deploy-DEV:
  tags:
    - ubtag
  only:
    - dev
  stage: deploy
  before_script:
    - 'which ssh-agent || (apk update && apk add openssh-client)'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIV_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -p $DEV_SERVER_PORT $DEV_SERVER_IP >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    # - ssh dorika@$DEV_SERVER_IP "./escare/test.sh $DB_URL $DB_USERNAME $DB_PASSWORD $MAIL_USERNAME $MAIL_PASSWORD"
    - nohup ssh dorika@$DEV_SERVER_IP "cd kubetest && nohup ./kuber.sh &" &
    - sleep 60s
    - cat nohup.out





# This is deploying for QA process, for testing.
# Using server is ESCARE server -- CentOS 7 server.
# Now(21.12.23) have connection issue, so use save server as DEVELOPMENT process.
deploy-QA:
  tags:
    - ubtag
  only:
    - QA
  stage: deploy
  before_script:
    - 'which ssh-agent || (apk update && apk add openssh-client)'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIV_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
#    - ssh-keyscan -p $QA_SERVER_PORT $QA_SERVER_IP >> ~/.ssh/known_hosts
    - ssh-keyscan -p $DEV_SERVER_PORT $DEV_SERVER_IP >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh dorika@$DEV_SERVER_IP "./escare/test.sh $DB_URL $DB_USERNAME $DB_PASSWORD $MAIL_USERNAME $MAIL_PASSWORD"


# This is deploying for PRODUCTION process, for testing.
# Using server is ESCARE server -- Ubuntu 20.04 server
# Now(21.12.23) have connection issue, so use save server as DEVELOPMENT process.
deploy-PROD:
  tags:
    - ubtag
  only:
    - main
  stage: deploy
  before_script:
    - 'which ssh-agent || (apk update && apk add openssh-client)'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIV_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    #    - ssh-keyscan -p $PROD_SERVER_PORT $PROD_SERVER_IP >> ~/.ssh/known_hosts
    - ssh-keyscan -p $DEV_SERVER_PORT $DEV_SERVER_IP >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh dorika@$DEV_SERVER_IP "./escare/test.sh $DB_URL $DB_USERNAME $DB_PASSWORD $MAIL_USERNAME $MAIL_PASSWORD"
